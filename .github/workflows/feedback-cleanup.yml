name: Cleanup Feedback Assets

on:
  issues:
    types: [closed]

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Extract metadata and delete assets
        uses: actions/github-script@v7
        with:
          script: |
            const issueBody = context.payload.issue.body || '';
            
            // Look for uifeedback metadata comment
            const metadataMatch = issueBody.match(/<!-- uifeedback-metadata: ({.*?}) -->/);
            
            if (!metadataMatch) {
              console.log('No uifeedback metadata found in issue body, skipping cleanup.');
              return;
            }
            
            let metadata;
            try {
              metadata = JSON.parse(metadataMatch[1]);
            } catch (e) {
              console.log('Failed to parse metadata:', e.message);
              return;
            }
            
            const { submissionId, branch, assetsPath } = metadata;
            
            if (!submissionId || !branch || !assetsPath) {
              console.log('Incomplete metadata, skipping cleanup.');
              return;
            }
            
            const assetDir = `${assetsPath}/${submissionId}`;
            console.log(`Cleaning up assets at: ${assetDir} on branch: ${branch}`);
            
            // List files in the asset directory
            let files;
            try {
              const response = await github.rest.repos.getContent({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path: assetDir,
                ref: branch,
              });
              
              files = Array.isArray(response.data) ? response.data : [response.data];
            } catch (e) {
              if (e.status === 404) {
                console.log('Asset directory not found, nothing to clean up.');
                return;
              }
              throw e;
            }
            
            // Delete each file
            for (const file of files) {
              if (file.type !== 'file') continue;
              
              console.log(`Deleting: ${file.path}`);
              await github.rest.repos.deleteFile({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path: file.path,
                message: `Cleanup feedback assets for issue #${context.payload.issue.number}`,
                sha: file.sha,
                branch: branch,
              });
            }
            
            console.log(`Successfully cleaned up ${files.length} asset(s) for issue #${context.payload.issue.number}`);

